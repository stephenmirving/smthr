@use 'sass:math';
@use 'sass:meta';
@use 'sass:string';
@use 'sass:map';
@use './is-alias' as *;
@use './is-angle' as *;
@use './strip-unit' as *;
@use './pi' as *;
@use './missing-dependencies' as *;

/// Takes a given $angle in either turns (turn), degrees (deg), gradians (grad),
/// or radian (rad) units, and converts that angle into an alternate unit type
/// defined by $convert-to,
///
/// @param {Angle|String} $angle - An angle value. Can be in turn, deg, grad,
/// or rad units. Can also be a keyword string with one of the following values:
/// `top`, `top-right`, `right`, `bottom-right`, `bottom`, `bottom-left`,
/// `left`, or `top-left`.
/// @param {String} $convert-to [deg] - The type of angle notation the given
/// $angle should be converted to.
///
/// @return {Angle} The converted angle.
///
/// @require {Function} missing-dependencies
/// @require {Function} is-alias
/// @require {Function} is-angle
/// @require {Function} strip-unit
/// @require {Function} pi
///
/// @throw {Error} Invalid $angle unit type.
/// @throw {Error} Invalid $angle keyword string.
/// @throw {Error} Invalid $angle data type.
/// @throw {Error} Invalid $convert-to angle unit keyword string.
@function conv-angle($angle, $convert-to: deg) {
  // $_missing: missing-dependencies('is-angle', 'strip-unit', 'pi');
  $start-unit: '';
  $directions-to-degrees: (
    'top': 0deg,
    'top-right': 45deg,
    'right': 90deg,
    'bottom-right': 135deg,
    'bottom': 180deg,
    'bottom-left': 225deg,
    'left': 270deg,
    'top-left': 315deg
  );
  $keyword-found: false;

  @if meta.type-of($angle) == 'number' {
    @if math.is-unitless($angle) {
      $angle: $angle * 1deg;
    }

    @if is-angle($angle) {
      $start-unit: math.unit($angle);
    } @else {
      @error 'Invalid $angle unit type passed to the [ conv-angle() ] function.' +
        'Valid angle units are `deg`, `turn`, `rad`, or `grad`.';
    }
  } @else if meta.type-of($angle) == 'string' {
    $angle: string.to-lower-case($angle);

    @each $direction, $value in $directions-to-degrees {
      @if not $keyword-found {
        @if is-alias($direction, $angle) {
          $keyword-found: true;
          $angle: $value;
          $start-unit: math.unit($angle);
        }
      }
    }

    @if not $keyword-found {
      @error 'Invalid $angle keyword passed to the [ conv-angle() ] function. ' +
          'Please either pass a valid angle, or use one of the following ' +
          'keyword options: `top`, `top-right`, `right`, `bottom-right`, ' +
          '`bottom`, `bottom-left`, `left`, or `top-left`.';
    }
  } @else {
    @error 'Invalid $angle data type of `#{meta.type-of($angle)}` passed to ' +
        'the [ conv-angle() ] function. You must pass either a number or ' +
        'a string.';
  }

  @if is-alias('turn', $convert-to) {
    $convert-to: turn;
  } @else if is-alias('deg', $convert-to) {
    $convert-to: deg;
  } @else if is-alias('rad', $convert-to) {
    $convert-to: rad;
  } @else if is-alias('grad', $convert-to) {
    $convert-to: grad;
  } @else {
    @error 'Invalid $convert-to unit name passed to the [ conv-angle() ] ' +
        'function. Valid angle units are `deg`, `turn`, `rad`, or `grad`.';
  }

  // If the angle is the same type as $convert-to, simply return it as-is.
  @if math.unit($angle) == $convert-to {
    @return $angle;
  }

  $angle: strip-unit($angle);

  @if $start-unit == 'turn' {
    @if $convert-to == 'deg' {
      $angle: 360deg * $angle;
    } @else if $convert-to == 'rad' {
      $angle: pi(2rad) * $angle;
    } @else if $convert-to == 'grad' {
      $angle: 400grad * $angle;
    }
  } @else if $start-unit == 'deg' {
    @if $convert-to == 'turn' {
      $angle: math.div($angle, 360) * 1turn;
    } @else if $convert-to == 'rad' {
      $angle: $angle * math.div(pi(), 180) * 1rad;
    } @else if $convert-to == 'grad' {
      $angle: $angle * math.div(200, 180) * 1grad;
    }
  } @else if $start-unit == 'rad' {
    @if $convert-to == 'turn' {
      $angle: math.div($angle, pi(2)) * 1turn;
    } @else if $convert-to == 'deg' {
      $angle: $angle * math.div(180, pi()) * 1deg;
    } @else if $convert-to == 'grad' {
      $angle: $angle * math.div(200, pi()) * 1grad;
    }
  } @else if $start-unit == 'grad' {
    @if $convert-to == 'turn' {
      $angle: math.div($angle, 400) * 1turn;
    } @else if $convert-to == 'deg' {
      $angle: $angle * math.div(180, 200) * 1deg;
    } @else if $convert-to == 'rad' {
      $angle: $angle * math.div(pi(), 200) * 1rad;
    }
  }

  @return $angle;
}
